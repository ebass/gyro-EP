%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          S u m m a r y   R e p o r t
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Compilation
-----------
File     : /global/u2/b/bassem/gyro-EP/shared/profiles_gen/src/prgen_read_gato.f90
Compiled : 01/19/21  15:34:59
Compiler : Version 9.1.0
Ftnlx    : Version 9.1.0 
Target   : x86-64
Command  : ftn_driver.exe -hcpu=haswell -hdynamic -D__CRAYXC -D__CRAY_HASWELL
           -D__CRAYXT_COMPUTE_LINUX_TARGET -hnetwork=aries -hnoomp -em
           -J/global/homes/b/bassem/gyro-EP/modules -sreal64 -eD -Ktrap=fp -m1
           -Rbcdps -G0 -I/opt/cray/pe/netcdf/4.6.3.2/CRAYCLANG/9.0/include
           -c prgen_read_gato.f90
           -I/opt/cray/pe/cce/9.1.0/cce-clang/x86_64/lib/clang/9.0.0/include
           -I/opt/cray/pe/cce/9.1.0/cce/x86_64/include/craylibs -I/usr/include
           -I/usr/include -I/opt/cray/pe/fftw/3.3.8.4/haswell/include
           -I/opt/cray/pe/libsci/19.06.1/CRAY/9.0/x86_64/include
           -I/opt/cray/pe/mpt/7.7.10/gni/mpich-cray/9.0/include
           -I/opt/cray/pe/hdf5/1.10.5.2/cray/9.0/include
           -I/opt/cray/pe/netcdf/4.6.3.2/cray/9.0/include
           -I/opt/cray/rca/2.2.20-7.0.1.1_4.53__g8e3fb5b.ari/include
           -I/opt/cray/alps/6.6.58-7.0.1.1_6.10__g437d88db.ari/include
           -I/opt/cray/xpmem/2.2.20-7.0.1.1_4.14__g0475745.ari/include
           -I/opt/cray/gni-headers/5.0.12.0-7.0.1.1_6.32__g3b1768f.ari/include
           -I/opt/cray/dmapp/7.1.1-7.0.1.1_4.54__g38cf134.ari/include
           -I/opt/cray/pe/pmi/5.0.14/include
           -I/opt/cray/ugni/6.0.14.0-7.0.1.1_7.40__ge78e5b0.ari/include
           -I/opt/cray/udreg/2.3.2-7.0.1.1_3.38__g8175d3d.ari/include
           -I/opt/cray/wlm_detect/1.3.3-7.0.1.1_4.16__g7109084.ari/include
           -I/opt/cray/krca/2.2.6-7.0.1.1_5.39__gb641b12.ari/include
           -I/opt/cray-hss-devel/9.0.0/include
Program
  Units  : PRGEN_READ_GATO

ftnlx report
------------
Source   : /global/u2/b/bassem/gyro-EP/shared/profiles_gen/src/prgen_read_gato.f90
Date     : 01/19/2021  15:35:00


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          S o u r c e   L i s t i n g
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    1.    !---------------------------------------------------------
    2.    ! prgen_read_gato.f90
    3.    !
    4.    ! PURPOSE:
    5.    !  Read data from GATO (eqgta, grid.dat, o1gta):
    6.    !
    7.    !  - psi (poloidal flux over 2pi)
    8.    !  - V(psi) (volume)
    9.    !  - dV(psi)/dpsi
   10.    !  - R(psi,arclength)
   11.    !  - Z(psi,arclength)
   12.    !  - q
   13.    !----------------------------------------------------------
   14.    
   15.    subroutine prgen_read_gato
   16.    
   17.      use prgen_globals
   18.    
   19.      implicit none
   20.    
   21.      integer :: i
   22.      integer :: ip
   23.      real :: fa,fb
   24.      real, dimension(:), allocatable :: gato_psi  
   25.      real, dimension(:), allocatable :: gato_dummy
   26.      real, dimension(:), allocatable :: gato_q
   27.      real, dimension(:), allocatable :: gato_p
   28.      real, dimension(:,:), allocatable :: gato_bigr
   29.      real, dimension(:,:), allocatable :: gato_bigz
   30.      real, dimension(:,:), allocatable :: gvec
   31.      real, dimension(:,:,:), allocatable :: g3vec
   32.      real, dimension(:,:,:), allocatable :: g3rho
   33.    
   34.      character (len=70) :: cdum
   35.    
   36.      !--------------------------------------------------
   37.      ! Read gfile header info
   38.      !
   39.      open(unit=1,file='eqgta',status='old')
   40.      read(1,'(a)') efit_header
   41.      close(1) 
   42.      !--------------------------------------------------
   43.      
   44.      !---------------------------------------------------
   45.      ! Read flux-surface data in GATO's grid.dat file
   46.      !
   47.      ! nsurf = number of finite flux surfaces
   48.      ! 
   49.      open(unit=1,file='out.gato.fluxsurf',status='old')
   50.      read(1,'(a)') cdum
   51.      read(1,*) nsurf,narc
   52.    
   53.      allocate(gato_psi(0:nsurf))
   54.      allocate(gato_dummy(0:nsurf))
   55.      allocate(gato_q(0:nsurf))
   56.      allocate(gato_p(0:nsurf))
   57.      allocate(gato_bigr(narc,nsurf))
   58.      allocate(gato_bigz(narc,nsurf))
   59.    
   60.      read(1,'(a)') cdum
   61.    
   62.      ! psi mesh
   63.      read(1,'(a)') cdum
   64.      read(1,*) gato_psi(:) 
   65.    
   66.      ! Volume
   67.      read(1,'(a)') cdum
   68.      read(1,*) gato_dummy(:)
   69.    
   70.      ! dVol/dpsi
   71.      read(1,'(a)') cdum
   72.      read(1,*) gato_dummy(:)
   73.    
   74.      ! Pressure
   75.      read(1,'(a)') cdum
   76.      read(1,*) gato_p(:)
   77.    
   78.      ! Safety Factor
   79.      read(1,'(a)') cdum
   80.      read(1,*) gato_q(:)
   81.    
   82.      ! 2D (R,Z)
   83.      read(1,'(a)') cdum
   84.      read(1,*) gato_bigr(:,:)
   85.      read(1,'(a)') cdum
   86.      read(1,*) gato_bigz(:,:)
   87.    
   88.      close(1)
   89.      !----------------------------------------------------
   90.    
   91.      !----------------------------------------------------------------
   92.      ! Correct flux variation in profile data (ITERDB, etc) 
   93.      !
   94.      if (format_type == 0 .or. format_type == 7) then
   95.         ! Case 1: raw gfile mode ; dpsi is undefined
   96.         dpsi_data = gato_psi(nsurf)
   97.         dpsi_efit = gato_psi(nsurf)
   98.         do i=1,nx
   99.            ! Shrink slightly for safety
  100.            dpsi(i) = (i-1)*dpsi_efit/(nx-1+1e-12)
  101.         enddo
  102.      else
  103.         ! Case 2: typical case 
  104.         dpsi_data = dpsi(nx)
  105.         dpsi_efit = gato_psi(nsurf)
  106.         
  107.         ! Ensure max(dpsi) = max(gato_psi) 
  108.         dpsi(:)  = dpsi(:)*dpsi_efit/dpsi_data
ftn-6263 ftn: VECTOR PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 108 
  A loop starting at line 108 was not vectorized because it contains a reference to a non-vector intrinsic on line 108.

  109.         ! Extra insurance against roundoff
  110.         dpsi(nx) = dpsi_efit
  111.      endif
  112.      !----------------------------------------------------------------
  113.    
  114.      !----------------------------------------------------------------
  115.      ! Get Miller-style (model shape) coefficients using 
  116.      ! fluxfit routines:
  117.      !
  118.      ! 1  r (cm)
  119.      ! 2  z_mag (cm)
  120.      ! 3  R0 (cm)
  121.      ! 4  kappa
  122.      ! 5  delta
  123.      ! 6  zeta
  124.      !
  125.      call fluxfit_driver(1,1,nsurf,narc,gato_bigr,gato_bigz,verbose_flag)
  126.      !
  127.      allocate(gvec(6,0:nsurf))
  128.    
  129.      open(unit=1,file='fluxfit.profile',status='old')
  130.      read(1,*) cdum
  131.      read(1,*) gvec(:,1:nsurf)
  132.      close(1)
  133.    
  134.      ! Explicitly set rmin=0 at origin
  135.      gvec(1,0) = 0.0
  136.    
  137.      ! Use extrapolation to get values of shape parameters at origin
  138.      do i=2,6
  139.         call bound_extrap(fa,fb,gvec(i,:),gato_psi,nsurf+1)
                                           ^                       
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 139, Column = 34 
  This argument produces a copy in and copy out to a temporary variable.

  140.         gvec(i,0) = fa
  141.      enddo
  142.    
  143.      ! Map shape coefficients onto poloidal flux (dpsi) grid:
  144.      ! NOTE: need sqrt here to get sensible behaviour as r -> 0.
  145.      call cub_spline(sqrt(gato_psi),gvec(1,:),nsurf+1,sqrt(dpsi),rmin,nx)
                            ^                                                    
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 145, Column = 19 
  This argument produces a copy in to a temporary variable.

                                               ^                                 
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 145, Column = 38 
  This argument produces a copy in and copy out to a temporary variable.

                                                             ^                   
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 145, Column = 52 
  This argument produces a copy in to a temporary variable.

  146.      call cub_spline(gato_psi,gvec(2,:),nsurf+1,dpsi,zmag,nx)
                                         ^                           
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 146, Column = 32 
  This argument produces a copy in and copy out to a temporary variable.

  147.      call cub_spline(gato_psi,gvec(3,:),nsurf+1,dpsi,rmaj,nx)
                                         ^                           
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 147, Column = 32 
  This argument produces a copy in and copy out to a temporary variable.

  148.      call cub_spline(gato_psi,gvec(4,:),nsurf+1,dpsi,kappa,nx)
                                         ^                            
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 148, Column = 32 
  This argument produces a copy in and copy out to a temporary variable.

  149.      call cub_spline(gato_psi,gvec(5,:),nsurf+1,dpsi,delta,nx)
                                         ^                            
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 149, Column = 32 
  This argument produces a copy in and copy out to a temporary variable.

  150.      call cub_spline(gato_psi,gvec(6,:),nsurf+1,dpsi,zeta,nx)
                                         ^                           
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 150, Column = 32 
  This argument produces a copy in and copy out to a temporary variable.

  151.    
  152.      ! Total pressure and q from GATO-EFIT 
  153.      ! (possible overwrite from raw data input in statefile)
  154.      if (nop_flag == 0) then
  155.         print '(a)','INFO: (prgen) Using total pressure from gfile.'
  156.         call cub_spline(gato_psi,gato_p,nsurf+1,dpsi,p_tot,nx)
  157.      endif
  158.      if (noq_flag == 0) then
  159.         print '(a)','INFO: (prgen) Using safety factor (q) from gfile.'
  160.         call cub_spline(gato_psi,gato_q,nsurf+1,dpsi,q,nx)
  161.      endif
  162.    
  163.      ! Explicitly set rmin=0 at origin
  164.      rmin(1) = 0.0
  165.    
  166.      deallocate(gvec)
  167.      !----------------------------------------------------------------
  168.    
  169.      !----------------------------------------------------
  170.      ! Get general geometry coefficients
  171.      !
  172.      call fluxfit_driver(2,nfourier,nsurf,narc,gato_bigr,gato_bigz,verbose_flag)
  173.    
  174.      allocate(g3vec(4,0:nfourier,0:nsurf))
  175.      allocate(g3rho(4,0:nfourier,nx))
  176.    
  177.      open(unit=1,file='fluxfit.geo',status='old')
  178.      read(1,*) ip
  179.      read(1,*) g3vec(:,:,1:nsurf)
  180.      close(1)
  181.    
  182.      ! Explicitly set rmin=0 at origin
  183.      g3vec(:,1:nfourier,0) = 0.0
ftn-6263 ftn: VECTOR PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 183 
  A loop starting at line 183 was not vectorized because it contains a reference to a non-vector intrinsic on line 183.

  184.    
  185.      ! Extrapolate centers (R0,Z0) to origin
  186.      do i=1,4
  187.         call bound_extrap(fa,fb,g3vec(i,0,:),gato_psi,nsurf+1)
                                            ^                         
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 187, Column = 35 
  This argument produces a copy in and copy out to a temporary variable.

  188.         g3vec(i,0,0) = fa
  189.      enddo
  190.    
  191.      ! Map results onto poloidal flux (dpsi) grid:
  192.      ! NOTE: need sqrt here to get sensible behaviour as r -> 0.
  193.      do i=1,4
  194.         do ip=0,nfourier
  195.            call cub_spline(sqrt(gato_psi),g3vec(i,ip,:),nsurf+1,sqrt(dpsi),g3rho(i,ip,:),nx)
                                  ^                                                                 
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 195, Column = 25 
  This argument produces a copy in to a temporary variable.

                                                      ^                                             
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 195, Column = 45 
  This argument produces a copy in and copy out to a temporary variable.

                                                                       ^                            
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 195, Column = 62 
  This argument produces a copy in to a temporary variable.

                                                                                       ^            
ftn-1438 ftn: CAUTION PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 195, Column = 78 
  This argument produces a copy in and copy out to a temporary variable.

  196.         enddo
  197.      enddo
  198.    
  199.      ! Explicitly set rmin=0 at origin
  200.      g3rho(:,1:nfourier,1) = 0.0
ftn-6263 ftn: VECTOR PRGEN_READ_GATO, File = prgen_read_gato.f90, Line = 200 
  A loop starting at line 200 was not vectorized because it contains a reference to a non-vector intrinsic on line 200.

  201.    
  202.      open(unit=1,file='input.profiles.geo',status='replace')
  203.      write(1,'(a)') '# input.profiles.geo'
  204.      write(1,'(a)') '#'
  205.      write(1,'(a)') '# See https://fusion.gat.com/theory/input.profiles.geo for complete documentation.'
  206.      write(1,'(a)') '#'
  207.      write(1,'(a)') '# File format:'
  208.      write(1,'(a)') '#-------------------'
  209.      write(1,'(a)') '# nfourier'
  210.      write(1,'(a)') '# a[4,0:nfourier,nx]'  
  211.      write(1,'(a)') '#-------------------'
  212.      write(1,'(a)') '#'
  213.      write(1,'(a)') '# NOTE: nx=EXPRO_n_exp is defined in input.profiles'
  214.      write(1,*) nfourier
  215.      write(1,'(1pe20.13)') g3rho(:,:,:)
  216.      close(1)
  217.      !----------------------------------------------------
  218.    
  219.      ! Clean up
  220.      deallocate(g3vec)
  221.      deallocate(g3rho)
  222.      deallocate(gato_psi)
  223.      deallocate(gato_q)
  224.      deallocate(gato_p)
  225.      deallocate(gato_dummy)
  226.      deallocate(gato_bigr)
  227.      deallocate(gato_bigz)
  228.    
  229.    end subroutine prgen_read_gato


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                         E x t e r n a l   R e p o r t
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Name  Messages
----  --------
BOUND_EXTRAP
      Defined as:  No definitions.

                   No calls.  It is not called and does not use any procedure.

      Interface:   None

Name  Messages
----  --------
CUB_SPLINE
      Defined as:  No definitions.

      Interface:   None

      Called By:   PRGEN_READ_GATO (Line 156, file prgen_read_gato.f90)
                   PRGEN_READ_GATO (Line 160, file prgen_read_gato.f90)

Name  Messages
----  --------
FLUXFIT_DRIVER
      Defined as:  No definitions.

      Interface:   None

      Called By:   PRGEN_READ_GATO (Line 125, file prgen_read_gato.f90)
                   PRGEN_READ_GATO (Line 172, file prgen_read_gato.f90)

Name  Messages
----  --------
PRGEN_GLOBALS
      Defined as:  No definitions.

      Used By:     PRGEN_READ_GATO

Name  Messages
----  --------
PRGEN_READ_GATO
      Defined as:  Subroutine (line 15, file prgen_read_gato.f90)

      Interface:   None

      Calls:       FLUXFIT_DRIVER (Line 125, file prgen_read_gato.f90)
                   FLUXFIT_DRIVER (Line 172, file prgen_read_gato.f90)
                   CUB_SPLINE (Line 156, file prgen_read_gato.f90)
                   CUB_SPLINE (Line 160, file prgen_read_gato.f90)

        Uses:      PRGEN_GLOBALS

Name  Messages
----  --------
SQRT(Intrinsic)
      Defined as:  No definitions.

                   No calls.  It is not called and does not use any procedure.

      Interface:   None


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
