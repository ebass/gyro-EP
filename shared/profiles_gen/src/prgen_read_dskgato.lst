%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          S u m m a r y   R e p o r t
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Compilation
-----------
File     : /global/u2/b/bassem/gyro-EP/shared/profiles_gen/src/prgen_read_dskgato.f90
Compiled : 01/19/21  15:34:58
Compiler : Version 9.1.0
Ftnlx    : Version 9.1.0 
Target   : x86-64
Command  : ftn_driver.exe -hcpu=haswell -hdynamic -D__CRAYXC -D__CRAY_HASWELL
           -D__CRAYXT_COMPUTE_LINUX_TARGET -hnetwork=aries -hnoomp -em
           -J/global/homes/b/bassem/gyro-EP/modules -sreal64 -eD -Ktrap=fp -m1
           -Rbcdps -G0 -I/opt/cray/pe/netcdf/4.6.3.2/CRAYCLANG/9.0/include
           -c prgen_read_dskgato.f90
           -I/opt/cray/pe/cce/9.1.0/cce-clang/x86_64/lib/clang/9.0.0/include
           -I/opt/cray/pe/cce/9.1.0/cce/x86_64/include/craylibs -I/usr/include
           -I/usr/include -I/opt/cray/pe/fftw/3.3.8.4/haswell/include
           -I/opt/cray/pe/libsci/19.06.1/CRAY/9.0/x86_64/include
           -I/opt/cray/pe/mpt/7.7.10/gni/mpich-cray/9.0/include
           -I/opt/cray/pe/hdf5/1.10.5.2/cray/9.0/include
           -I/opt/cray/pe/netcdf/4.6.3.2/cray/9.0/include
           -I/opt/cray/rca/2.2.20-7.0.1.1_4.53__g8e3fb5b.ari/include
           -I/opt/cray/alps/6.6.58-7.0.1.1_6.10__g437d88db.ari/include
           -I/opt/cray/xpmem/2.2.20-7.0.1.1_4.14__g0475745.ari/include
           -I/opt/cray/gni-headers/5.0.12.0-7.0.1.1_6.32__g3b1768f.ari/include
           -I/opt/cray/dmapp/7.1.1-7.0.1.1_4.54__g38cf134.ari/include
           -I/opt/cray/pe/pmi/5.0.14/include
           -I/opt/cray/ugni/6.0.14.0-7.0.1.1_7.40__ge78e5b0.ari/include
           -I/opt/cray/udreg/2.3.2-7.0.1.1_3.38__g8175d3d.ari/include
           -I/opt/cray/wlm_detect/1.3.3-7.0.1.1_4.16__g7109084.ari/include
           -I/opt/cray/krca/2.2.6-7.0.1.1_5.39__gb641b12.ari/include
           -I/opt/cray-hss-devel/9.0.0/include
Program
  Units  : PRGEN_READ_DSKGATO

ftnlx report
------------
Source   : /global/u2/b/bassem/gyro-EP/shared/profiles_gen/src/prgen_read_dskgato.f90
Date     : 01/19/2021  15:34:59


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                          S o u r c e   L i s t i n g
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    1.    !---------------------------------------------------------
    2.    ! prgen_read_dskgato.f90
    3.    !
    4.    ! PURPOSE:
    5.    !  Read DSKGATO format.
    6.    !  efit_method=4: old dskgato
    7.    !  efit_method=5: new dskgato
    8.    !----------------------------------------------------------
    9.    
   10.    subroutine prgen_read_dskgato
   11.    
   12.      use prgen_globals
   13.    
   14.      implicit none
   15.    
   16.      integer :: i,ip
   17.      integer :: neqtyp
   18.      integer :: ntht,neqsym
   19.      real :: fa,fb
   20.      real :: dummy(4)
   21.      real, dimension(:), allocatable :: psi
   22.      real, dimension(:), allocatable :: q_dsk
   23.      real, dimension(:), allocatable :: pdum
   24.      real, dimension(:), allocatable :: tdum
   25.      real, dimension(:,:), allocatable :: xs
   26.      real, dimension(:,:), allocatable :: zs
   27.    
   28.      real, dimension(:,:), allocatable :: gvec
   29.      real, dimension(:,:,:), allocatable :: g3vec
   30.      real, dimension(:,:,:), allocatable :: g3rho
   31.    
   32.      character (len=70) :: cdum
   33.    
   34.      !---------------------------------------------------
   35.      ! 
   36.      if (efit_method == 4) then
   37.         neqtyp=1
   38.      else
   39.         neqtyp=0
   40.      endif
   41.      open(unit=1,file='grid.dat',status='old')
   42.      if (neqtyp == 0) then
   43.         read(1,'(a)') cdum
   44.         read(1,'(a)') cdum
   45.         read(1,*) nsurf,ntht,neqsym
   46.         print '(a)','INFO: (prgen) Assuming new-type dskgato flux-surface format.'
   47.      else
   48.         read(1,*) nsurf,ntht
   49.         neqsym = 1
   50.         print '(a)','INFO: (prgen) Assuming old-type dskgato flux-surface format.' 
   51.      endif
   52.      ! Accounting for magnetic axis
   53.      nsurf = nsurf-1
   54.    
   55.      if (neqsym == 0) then
   56.         narc = ntht
   57.      else
   58.         ! Repeat point
   59.         narc = 2*(ntht-1)+1
   60.      endif
   61.    
   62.      read (1,10) dummy(1:4)
   63.    
   64.      if (neqtyp == 0) read(1,10) dummy(1:2) ! totcur,axddxz
   65.      if (neqtyp == 1) read(1,10) dummy(1:3) ! totcur,axddxz,dnnorm
   66.    
   67.      allocate(tdum(ntht))
   68.      allocate(psi(0:nsurf))
   69.      allocate(q_dsk(0:nsurf))
   70.      allocate(pdum(0:nsurf))
   71.      allocate(xs(narc,0:nsurf))
   72.      allocate(zs(narc,0:nsurf))
   73.    
   74.      read(1,10) psi(:)
   75.      read(1,10) pdum(:) ! fval
   76.      read(1,10) pdum(:) ! ffprime
   77.      read(1,10) pdum(:) ! sp
   78.      read(1,10) pdum(:) ! pprime
   79.      read(1,10) q_dsk(:) ! qsfin
   80.      read(1,10) pdum(:) ! nel
   81.    
   82.      read(1,10) tdum(:) ! seqdpdr
   83.      read(1,10) tdum(:) ! seqdpdz
   84.    
   85.      ! These arrays should repeat endpoint
   86.      read(1,10) ((xs(i,ip),ip=0,nsurf),i=1,ntht)
   87.      read(1,10) ((zs(i,ip),ip=0,nsurf),i=1,ntht)
   88.      close(1)
   89.    
   90.      if (neqsym == 1) then
   91.         zs(1,:)    = 0.0
ftn-6263 ftn: VECTOR PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 91 
  A loop starting at line 91 was not vectorized because it contains a reference to a non-vector intrinsic on line 91.

   92.         zs(ntht,:) = 0.0
ftn-6263 ftn: VECTOR PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 92 
  A loop starting at line 92 was not vectorized because it contains a reference to a non-vector intrinsic on line 92.

   93.         do i=ntht+1,narc
   94.            ip = narc+1-i
   95.            xs(i,:) = +xs(ip,:)
ftn-6263 ftn: VECTOR PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 95 
  A loop starting at line 95 was not vectorized because it contains a reference to a non-vector intrinsic on line 95.

   96.            zs(i,:) = -zs(ip,:)
ftn-6263 ftn: VECTOR PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 96 
  A loop starting at line 96 was not vectorized because it contains a reference to a non-vector intrinsic on line 96.

   97.         enddo
   98.      endif
   99.    
  100.      !do i=1,narc
  101.      !   print *,i,xs(i,nsurf/2),zs(i,nsurf/2)
  102.      !enddo
  103.    
  104.      ! Set psi(1) = 0
  105.      psi(:) = psi(:)-psi(0)
ftn-6263 ftn: VECTOR PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 105 
  A loop starting at line 105 was not vectorized because it contains a reference to a non-vector intrinsic on line 105.

  106.    
  107.      ! COORDINATES: set sign of poloidal flux
  108.      if (psi(nsurf) < 0.0) then
  109.         ! Flux negative
  110.         psi(:) = -psi(:)
ftn-6263 ftn: VECTOR PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 110 
  A loop starting at line 110 was not vectorized because it contains a reference to a non-vector intrinsic on line 110.

  111.         ipccw  = 1
  112.      else
  113.         ipccw = -1
  114.      endif
  115.      !----------------------------------------------------
  116.    
  117.      !----------------------------------------------------------------
  118.      ! Correct flux variation in profile data (ITERDB, etc) 
  119.      !
  120.      if (format_type == 0 .or. format_type == 7) then
  121.         ! Case 1: raw gfile mode ; dpsi is undefined
  122.         dpsi_data = psi(nsurf)
  123.         dpsi_efit = psi(nsurf)
  124.         do i=1,nx
  125.            ! Shrink slightly for safety
  126.            dpsi(i) = (i-1)*dpsi_efit/(nx-1+1e-12)
  127.         enddo
  128.      else
  129.         ! Case 2: typical case 
  130.         dpsi_data = dpsi(nx)
  131.         dpsi_efit = psi(nsurf)
  132.    
  133.         ! Ensure max(dpsi) = max(gato_psi) 
  134.         dpsi(:)  = dpsi(:)*dpsi_efit/dpsi_data
ftn-6263 ftn: VECTOR PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 134 
  A loop starting at line 134 was not vectorized because it contains a reference to a non-vector intrinsic on line 134.

  135.         ! Extra insurance against roundoff
  136.         dpsi(nx) = dpsi_efit 
  137.      endif
  138.      !----------------------------------------------------------------
  139.    
  140.      !----------------------------------------------------------------
  141.      ! Get Miller-style (model shape) coefficients using 
  142.      ! fluxfit routines:
  143.      !
  144.      ! 1  r (cm)
  145.      ! 2  z_mag (cm)
  146.      ! 3  R0 (cm)
  147.      ! 4  kappa
  148.      ! 5  delta
  149.      ! 6  zeta
  150.      !
  151.      call fluxfit_driver(1,1,nsurf,narc,xs(:,1:nsurf),zs(:,1:nsurf),verbose_flag)
  152.      !
  153.      allocate(gvec(6,0:nsurf))
  154.      !
  155.      open(unit=1,file='fluxfit.profile',status='old')
  156.      read(1,*) cdum
  157.      read(1,*) gvec(:,1:nsurf)
  158.      close(1)
  159.    
  160.      ! Explicitly set rmin=0 at origin
  161.      gvec(1,0) = 0.0
  162.    
  163.      ! Use extrapolation to get values of shape parameters at origin
  164.      do i=2,6
  165.         call bound_extrap(fa,fb,gvec(i,:),psi,nsurf+1)
                                           ^                  
ftn-1438 ftn: CAUTION PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 165, Column = 34 
  This argument produces a copy in and copy out to a temporary variable.

  166.         gvec(i,0) = fa
  167.      enddo
  168.    
  169.      ! Map shape coefficients onto poloidal flux (dpsi) grid:
  170.      call cub_spline(sqrt(psi),gvec(1,:),nsurf+1,sqrt(dpsi),rmin,nx)
                            ^                                               
ftn-1438 ftn: CAUTION PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 170, Column = 19 
  This argument produces a copy in to a temporary variable.

                                          ^                                 
ftn-1438 ftn: CAUTION PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 170, Column = 33 
  This argument produces a copy in and copy out to a temporary variable.

                                                        ^                   
ftn-1438 ftn: CAUTION PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 170, Column = 47 
  This argument produces a copy in to a temporary variable.

  171.      call cub_spline(psi,gvec(2,:),nsurf+1,dpsi,zmag,nx)
                                    ^                           
ftn-1438 ftn: CAUTION PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 171, Column = 27 
  This argument produces a copy in and copy out to a temporary variable.

  172.      call cub_spline(psi,gvec(3,:),nsurf+1,dpsi,rmaj,nx)
                                    ^                           
ftn-1438 ftn: CAUTION PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 172, Column = 27 
  This argument produces a copy in and copy out to a temporary variable.

  173.      call cub_spline(psi,gvec(4,:),nsurf+1,dpsi,kappa,nx)
                                    ^                            
ftn-1438 ftn: CAUTION PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 173, Column = 27 
  This argument produces a copy in and copy out to a temporary variable.

  174.      call cub_spline(psi,gvec(5,:),nsurf+1,dpsi,delta,nx)
                                    ^                            
ftn-1438 ftn: CAUTION PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 174, Column = 27 
  This argument produces a copy in and copy out to a temporary variable.

  175.      call cub_spline(psi,gvec(6,:),nsurf+1,dpsi,zeta,nx)
                                    ^                           
ftn-1438 ftn: CAUTION PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 175, Column = 27 
  This argument produces a copy in and copy out to a temporary variable.

  176.    
  177.      ! Explicitly set rmin=0 at origin
  178.      rmin(1) = 0.0
  179.    
  180.      deallocate(gvec)
  181.      !----------------------------------------------------------------
  182.    
  183.      !----------------------------------------------------------------
  184.      ! Get general geometry coefficients
  185.      !
  186.      call fluxfit_driver(2,nfourier,nsurf,narc,xs(:,1:nsurf),zs(:,1:nsurf),verbose_flag)
  187.    
  188.      allocate(g3vec(4,0:nfourier,0:nsurf))
  189.      allocate(g3rho(4,0:nfourier,nx))
  190.    
  191.      open(unit=1,file='fluxfit.geo',status='old')
  192.      read(1,*) ip
  193.      read(1,*) g3vec(:,:,1:nsurf)
  194.      close(1)
  195.    
  196.      ! Explicitly set rmin=0 at origin
  197.      g3vec(:,1:nfourier,0) = 0.0
ftn-6263 ftn: VECTOR PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 197 
  A loop starting at line 197 was not vectorized because it contains a reference to a non-vector intrinsic on line 197.

  198.    
  199.      ! Extrapolate centers (R0,Z0) to origin
  200.      do i=1,4
  201.         call bound_extrap(fa,fb,g3vec(i,0,:),psi,nsurf+1)
                                            ^                    
ftn-1438 ftn: CAUTION PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 201, Column = 35 
  This argument produces a copy in and copy out to a temporary variable.

  202.         g3vec(i,0,0) = fa
  203.      enddo
  204.    
  205.      ! Map Fourier coefficients onto poloidal flux (dpsi) grid 
  206.      do i=1,4
  207.         do ip=0,nfourier
  208.            call cub_spline(psi,g3vec(i,ip,:),nsurf+1,dpsi,g3rho(i,ip,:),nx)
                                           ^                                       
ftn-1438 ftn: CAUTION PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 208, Column = 34 
  This argument produces a copy in and copy out to a temporary variable.

                                                                      ^            
ftn-1438 ftn: CAUTION PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 208, Column = 61 
  This argument produces a copy in and copy out to a temporary variable.

  209.         enddo
  210.      enddo
  211.    
  212.      ! Explicitly set rmin=0 at origin
  213.      g3rho(:,1:nfourier,1) = 0.0
ftn-6263 ftn: VECTOR PRGEN_READ_DSKGATO, File = prgen_read_dskgato.f90, Line = 213 
  A loop starting at line 213 was not vectorized because it contains a reference to a non-vector intrinsic on line 213.

  214.    
  215.      open(unit=1,file='input.profiles.geo',status='replace')
  216.      write(1,'(a)') '# input.profiles.geo'
  217.      write(1,'(a)') '#'
  218.      write(1,'(a)') '# See https://fusion.gat.com/theory/input.profiles.geo for complete documentation.'
  219.      write(1,'(a)') '#'
  220.      write(1,'(a)') '# File format:'
  221.      write(1,'(a)') '#-------------------'
  222.      write(1,'(a)') '# nfourier'
  223.      write(1,'(a)') '# a[4,0:nfourier,nx]'  
  224.      write(1,'(a)') '#-------------------'
  225.      write(1,'(a)') '#'
  226.      write(1,'(a)') '# NOTE: nx=EXPRO_n_exp is defined in input.profiles'
  227.      write(1,*) nfourier
  228.      write(1,'(1pe20.13)') g3rho(:,:,:)
  229.      close(1)
  230.      !----------------------------------------------------------------
  231.    
  232.      if (noq_flag == 0) then
  233.         call cub_spline(psi,q_dsk,nsurf+1,dpsi,q,nx)
  234.      endif
  235.    
  236.      ! Cleanup
  237.      deallocate(g3vec)
  238.      deallocate(g3rho)
  239.      deallocate(xs)
  240.      deallocate(zs)
  241.      deallocate(psi)
  242.      deallocate(tdum)
  243.      deallocate(pdum)
  244.      deallocate(q_dsk)
  245.     
  246.    10 format(1p4e19.12)
  247.    
  248.    end subroutine prgen_read_dskgato


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                         E x t e r n a l   R e p o r t
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Name  Messages
----  --------
BOUND_EXTRAP
      Defined as:  No definitions.

                   No calls.  It is not called and does not use any procedure.

      Interface:   None

Name  Messages
----  --------
CUB_SPLINE
      Defined as:  No definitions.

      Interface:   None

      Called By:   PRGEN_READ_DSKGATO (Line 233, file prgen_read_dskgato.f90)

Name  Messages
----  --------
FLUXFIT_DRIVER
      Defined as:  No definitions.

      Interface:   None

      Called By:   PRGEN_READ_DSKGATO (Line 151, file prgen_read_dskgato.f90)
                   PRGEN_READ_DSKGATO (Line 186, file prgen_read_dskgato.f90)

Name  Messages
----  --------
PRGEN_GLOBALS
      Defined as:  No definitions.

      Used By:     PRGEN_READ_DSKGATO

Name  Messages
----  --------
PRGEN_READ_DSKGATO
      Defined as:  Subroutine (line 10, file prgen_read_dskgato.f90)

      Interface:   None

      Calls:       FLUXFIT_DRIVER (Line 151, file prgen_read_dskgato.f90)
                   FLUXFIT_DRIVER (Line 186, file prgen_read_dskgato.f90)
                   CUB_SPLINE (Line 233, file prgen_read_dskgato.f90)

        Uses:      PRGEN_GLOBALS

Name  Messages
----  --------
SQRT(Intrinsic)
      Defined as:  No definitions.

                   No calls.  It is not called and does not use any procedure.

      Interface:   None


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
